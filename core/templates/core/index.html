<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒê·ªÅ c∆∞∆°ng</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-radius: 0.375rem;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        body {
            font-family: var(--font-family);
            background-color: var(--light-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--dark-color);
        }
        .container {
            width: 100%;
            max-width: 900px;
            margin: auto;
        }
        
        /* --- GIAO DI·ªÜN CH√çNH (APP) --- */
        #app {
            display: none; /* ·∫®n ban ƒë·∫ßu */
            background-color: #ffffff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid #dee2e6;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #dee2e6;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .main-content {
            padding: 1.5rem;
        }
        .form-section {
            margin-bottom: 1.5rem;
        }
        .form-section h2 {
            font-size: 1.25rem;
            color: var(--dark-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            margin-top: 0;
            margin-bottom: 1rem;
        }
        textarea, .form-section input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            font-family: var(--font-family);
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            box-sizing: border-box; /* Quan tr·ªçng */
            line-height: 1.5;
        }
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        .btn {
            display: inline-block;
            font-weight: 600;
            color: #ffffff;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            background-color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 0.625rem 1.25rem;
            font-size: 1rem;
            border-radius: var(--border-radius);
            text-decoration: none;
            transition: all 0.15s ease-in-out;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }
        .btn-logout {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        .btn-save {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        .btn-submit-final {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
            color: var(--dark-color);
        }
        .btn-ai {
            background-color: #6f42c1; /* M√†u t√≠m */
            border-color: #6f42c1;
        }
        .btn-download {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        .ai-suggestion-box {
            position: relative;
        }
        .btn-ai {
            position: absolute;
            bottom: 15px;
            right: 15px;
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }
        #save-status {
            font-style: italic;
            color: var(--secondary-color);
            margin-left: 10px;
        }
        .form-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            border-top: 1px solid #eee; 
            padding-top: 1.5rem;
        }
        #current-status {
            margin-right: auto; /* ƒê·∫©y tr·∫°ng th√°i sang tr√°i */
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
        }
        #current-status.ban_nhap { background-color: #e2e3e5; color: #5a6268; }
        #current-status.da_nop { background-color: #d4edda; color: #155724; }
        #current-status.can_chinh_sua { background-color: #fff3cd; color: #856404; }
        #current-status.da_duyet { background-color: #cce5ff; color: #004085; }

        /* --- GIAO DI·ªÜN ƒêƒÇNG NH·∫¨P / ƒêƒÇNG K√ù --- */
        .auth-container {
            width: 100%;
            max-width: 450px;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid #dee2e6;
        }
        .auth-container h1 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 1.5rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            box-sizing: border-box; /* Quan tr·ªçng */
        }
        .btn-submit {
            width: 100%;
            padding: 0.75rem;
            font-size: 1.125rem;
        }
        .auth-switch {
            text-align: center;
            margin-top: 1rem;
        }
        .auth-switch a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }
        .auth-switch a:hover {
            text-decoration: underline;
        }
        .error-message {
            color: var(--danger-color);
            text-align: center;
            margin-top: 1rem;
            display: none; /* ·∫®n ban ƒë·∫ßu */
        }

        /* --- MODAL (C·ª≠a s·ªï Pop-up) --- */
        .modal {
            display: none; /* ·∫®n ban ƒë·∫ßu */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
        }
        .modal-body {
            padding: 15px;
            line-height: 1.6;
            white-space: pre-wrap; /* Quan tr·ªçng: ƒë·ªÉ gi·ªØ ƒë·ªãnh d·∫°ng xu·ªëng d√≤ng c·ªßa AI */
        }
        .modal-body p {
            margin: 0;
        }
        #modal-loading {
            text-align: center;
            font-style: italic;
            color: var(--secondary-color);
        }

    </style>
</head>
<body>

    <div class="container">

        <div id="login-view" class="auth-container">
            <form id="login-form">
                <h1>ƒêƒÉng nh·∫≠p H·ªá th·ªëng</h1>
                <div class="form-group">
                    <label for="login-username">T√™n ƒëƒÉng nh·∫≠p (Username)</label>
                    <input type="text" id="login-username" required>
                </div>
                <div class="form-group">
                    <label for="login-password">M·∫≠t kh·∫©u</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn btn-submit">ƒêƒÉng nh·∫≠p</button>
                <p id="login-error" class="error-message"></p>
                <div class="auth-switch">
                    <p>Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" id="show-register">ƒêƒÉng k√Ω ngay</a></p>
                </div>
            </form>
        </div>

        <div id="register-view" class="auth-container" style="display: none;">
            <form id="register-form">
                <h1>ƒêƒÉng k√Ω t√†i kho·∫£n</h1>
                <div class="form-group">
                    <label for="register-hoten">H·ªç v√† t√™n</label>
                    <input type="text" id="register-hoten" required>
                </div>
                <div class="form-group">
                    <label for="register-username">T√™n ƒëƒÉng nh·∫≠p (Username)</label>
                    <input type="text" id="register-username" required>
                </div>
                <div class="form-group">
                    <label for="register-password">M·∫≠t kh·∫©u</label>
                    <input type="password" id="register-password" required>
                </div>
                <button type="submit" class="btn btn-submit">ƒêƒÉng k√Ω</button>
                <p id="register-error" class="error-message"></p>
                <div class="auth-switch">
                    <p>ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" id="show-login">ƒêƒÉng nh·∫≠p</a></p>
                </div>
            </form>
        </div>

        <div id="app">
            <header class="header">
                <h1>Qu·∫£n l√Ω ƒê·ªÅ c∆∞∆°ng Lu·∫≠n vƒÉn</h1>
                <div class="header-controls">
                    <span id="welcome-message" style="margin-right: 15px;"></span>
                    <button type="button" id="btn-logout" class="btn btn-logout">ƒêƒÉng xu·∫•t</button>
                </div>
            </header>

            <main class="main-content">
                <form id="decuong-form">
                    <div class="form-section">
                        <h2>Th√¥ng tin chung</h2>
                        <label for="ten-de-tai" style="font-weight: 600; margin-bottom: 5px; display: block;">T√™n ƒë·ªÅ t√†i:</label>
                        <input type="text" id="ten-de-tai" placeholder="Nh·∫≠p t√™n ƒë·ªÅ t√†i c·ªßa b·∫°n...">
                    </div>

                    <div class="form-section">
                        <h2>Ph·∫ßn M·ªü ƒë·∫ßu</h2>
                        <label for="ly-do-chon-de-tai" style="font-weight: 600; margin-bottom: 5px; display: block;">1. L√Ω do ch·ªçn ƒë·ªÅ t√†i (T√≠nh c·∫•p thi·∫øt)</label>
                        <div class="ai-suggestion-box">
                            <textarea id="ly-do-chon-de-tai" placeholder="Nh·∫≠p n·ªôi dung..."></textarea>
                            <button type="button" id="btn-ai-lydo" class="btn btn-ai">ü§ñ G·ª£i √Ω AI</button>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2>Ch∆∞∆°ng 1: C∆° s·ªü l√Ω lu·∫≠n v√† th·ª±c ti·ªÖn (Khung l√Ω thuy·∫øt)</h2>
                        <div class="ai-suggestion-box">
                            <textarea id="khung-ly-thuyet" placeholder="Nh·∫≠p n·ªôi dung..."></textarea>
                            <button type="button" id="btn-ai-khunglythuyet" class="btn btn-ai">ü§ñ G·ª£i √Ω AI</button>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2>Ch∆∞∆°ng 2: Thi·∫øt k·∫ø v√† T·ªï ch·ª©c D·∫°y h·ªçc</h2>
                        <div class="ai-suggestion-box">
                            <textarea id="thiet-ke-va-to-chuc" placeholder="Nh·∫≠p n·ªôi dung..."></textarea>
                            <button type="button" id="btn-ai-thietke" class="btn btn-ai">ü§ñ G·ª£i √Ω AI</button>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h2>Ch∆∞∆°ng 3: Th·ª±c nghi·ªám S∆∞ ph·∫°m</h2>
                        <div class="ai-suggestion-box">
                            <textarea id="thuc-nghiem" placeholder="Nh·∫≠p n·ªôi dung..."></textarea>
                            <button type="button" id="btn-ai-thucnghiem" class="btn btn-ai">ü§ñ G·ª£i √Ω AI</button>
                        </div>
                    </div>

                    <div class="form-controls">
                        <span id="current-status"></span>
                        
                        <button type="button" id="btn-download-pdf" class="btn btn-download">üìÑ T·∫£i PDF</button>
                        <button type="button" id="btn-save-draft" class="btn btn-save">üíæ L∆∞u nh√°p</button>
                        <button type="button" id="btn-submit-final" class="btn btn-submit-final">üì§ N·ªôp b√†i</button>
                        <span id="save-status"></span>
                    </div>
                </form>
            </main>
        </div>

    </div>

    <div id="aiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tr·ª£ l√Ω AI G·ª£i √Ω</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <div id="modal-loading">
                    <p>ƒêang li√™n h·ªá v·ªõi Tr·ª£ l√Ω AI, vui l√≤ng ch·ªù...</p>
                </div>
                <div id="modal-result" style="display: none;">
                    </div>
                <div id="modal-error" style="display: none; color: var(--danger-color);">
                    <p>L·ªói: Kh√¥ng th·ªÉ nh·∫≠n g·ª£i √Ω t·ª´ AI. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
                </div>
            </div>
        </div>
    </div>


    <script>
        // === C√ÄI ƒê·∫∂T CHUNG ===
        const API_URL = '/api'; // D√πng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi

        // L·∫•y c√°c element
        const appView = document.getElementById('app');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');

        // Form
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const decuongForm = document.getElementById('decuong-form');

        // Th√¥ng b√°o l·ªói
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');

        // N√∫t
        const btnLogout = document.getElementById('btn-logout');
        const btnSaveDraft = document.getElementById('btn-save-draft');
        const btnSubmitFinal = document.getElementById('btn-submit-final');
        const btnDownloadPDF = document.getElementById('btn-download-pdf');
        
        // N√∫t AI (S·ª≠a l·ªói: Th√™m 3 n√∫t m·ªõi)
        const btnAiLyDo = document.getElementById('btn-ai-lydo');
        const btnAiKhungLyThuyet = document.getElementById('btn-ai-khunglythuyet');
        const btnAiThietKe = document.getElementById('btn-ai-thietke');
        const btnAiThucNghiem = document.getElementById('btn-ai-thucnghiem');

        const showLoginLink = document.getElementById('show-login');
        const showRegisterLink = document.getElementById('show-register');

        // N·ªôi dung ƒë·ªÅ c∆∞∆°ng
        const elTenDeTai = document.getElementById('ten-de-tai');
        const elLyDo = document.getElementById('ly-do-chon-de-tai');
        const elKhungLyThuyet = document.getElementById('khung-ly-thuyet');
        const elThietKe = document.getElementById('thiet-ke-va-to-chuc');
        const elThucNghiem = document.getElementById('thuc-nghiem');
        const saveStatus = document.getElementById('save-status');
        const currentStatus = document.getElementById('current-status');

        // Modal
        const aiModal = document.getElementById('aiModal');
        const modalLoading = document.getElementById('modal-loading');
        const modalResult = document.getElementById('modal-result');
        const modalError = document.getElementById('modal-error');
        const closeModalBtn = document.querySelector('.close-btn');
        

        // === C√ÅC H√ÄM X·ª¨ L√ù ===

        // --- 1. H√ÄM G·ªåI API C√ì X√ÅC TH·ª∞C (TOKEN) ---
        async function fetchAuthenticated(url, options = {}) {
            const accessToken = localStorage.getItem('access_token');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
            };

            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }

            const res = await fetch(url, { ...options, headers });

            if (res.status === 401) {
                // Token h·∫øt h·∫°n, th·ª≠ refresh
                try {
                    const refreshRes = await fetch(`${API_URL}/token/refresh/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ refresh: localStorage.getItem('refresh_token') })
                    });
                    
                    if (refreshRes.ok) {
                        const data = await refreshRes.json();
                        localStorage.setItem('access_token', data.access);
                        // G·ªçi l·∫°i h√†m ban ƒë·∫ßu v·ªõi token m·ªõi
                        headers['Authorization'] = `Bearer ${data.access}`;
                        return await fetch(url, { ...options, headers });
                    } else {
                        // Refresh th·∫•t b·∫°i, ƒëƒÉng xu·∫•t
                        doLogout();
                        return res; // Tr·∫£ v·ªÅ l·ªói
                    }
                } catch (e) {
                    doLogout();
                    return res; // Tr·∫£ v·ªÅ l·ªói
                }
            }
            return res;
        }

        // --- 2. X·ª¨ L√ù ƒêƒÇNG NH·∫¨P ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            loginError.style.display = 'none';

            try {
                const response = await fetch(`${API_URL}/token/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    localStorage.setItem('username', username);
                    showAppView(username);
                } else {
                    const errorData = await response.json();
                    loginError.textContent = errorData.detail || 'L·ªói k·∫øt n·ªëi m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.';
                    loginError.style.display = 'block';
                }
            } catch (err) {
                loginError.textContent = 'L·ªói k·∫øt n·ªëi m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.';
                loginError.style.display = 'block';
            }
        });

        // --- 3. X·ª¨ L√ù ƒêƒÇNG K√ù ---
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const ho_ten = document.getElementById('register-hoten').value;
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            registerError.style.display = 'none';
            
            try {
                const response = await fetch(`${API_URL}/register/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ho_ten, username, password })
                });

                if (response.status === 201) {
                    alert('ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.');
                    showLoginView();
                } else {
                    const errorData = await response.json();
                    registerError.textContent = Object.values(errorData).join(' ');
                    registerError.style.display = 'block';
                }
            } catch (err) {
                registerError.textContent = 'L·ªói k·∫øt n·ªëi m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.';
                registerError.style.display = 'block';
            }
        });

        // --- 4. X·ª¨ L√ù ƒêƒÇNG XU·∫§T ---
        btnLogout.addEventListener('click', doLogout);

        function doLogout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('username');
            showLoginView();
        }

        // --- 5. T·∫¢I D·ªÆ LI·ªÜU ƒê·ªÄ C∆Ø∆†NG (GET) ---
        async function loadDeCuong() {
            try {
                const response = await fetchAuthenticated(`${API_URL}/de-cuong/`);
                if (response.ok) {
                    const data = await response.json();
                    elTenDeTai.value = data.ten_de_tai || '';
                    elLyDo.value = data.ly_do_chon_de_tai || '';
                    elKhungLyThuyet.value = data.khung_ly_thuyet || '';
                    elThietKe.value = data.thiet_ke_va_to_chuc || '';
                    elThucNghiem.value = data.thuc_nghiem || '';
                    
                    // S·ª≠a l·ªói: Th√™m code hi·ªÉn th·ªã tr·∫°ng th√°i
                    updateStatusUI(data.trang_thai);
                } else {
                    console.error('Kh√¥ng th·ªÉ t·∫£i ƒë·ªÅ c∆∞∆°ng.');
                }
            } catch (err) {
                console.error('L·ªói t·∫£i ƒë·ªÅ c∆∞∆°ng:', err);
            }
        }
        
        // H√†m c·∫≠p nh·∫≠t giao di·ªán tr·∫°ng th√°i
        function updateStatusUI(status) {
            const statusMap = {
                'ban_nhap': 'Tr·∫°ng th√°i: B·∫£n nh√°p',
                'da_nop': 'Tr·∫°ng th√°i: ƒê√£ n·ªôp (Ch·ªù duy·ªát)',
                'can_chinh_sua': 'Tr·∫°ng th√°i: C·∫ßn ch·ªânh s·ª≠a',
                'da_duyet': 'Tr·∫°ng th√°i: ƒê√£ duy·ªát'
            };
            currentStatus.textContent = statusMap[status] || 'Tr·∫°ng th√°i: B·∫£n nh√°p';
            currentStatus.className = status; // G√°n class ƒë·ªÉ ƒë·ªïi m√†u
            
            // Kh√≥a form n·∫øu ƒë√£ n·ªôp ho·∫∑c ƒë√£ duy·ªát
            const isLocked = (status === 'da_nop' || status === 'da_duyet');
            const allInputs = decuongForm.querySelectorAll('textarea, input, button');
            allInputs.forEach(input => {
                // Kh√¥ng kh√≥a c√°c n√∫t quan tr·ªçng
                if (input.id !== 'btn-logout' && input.id !== 'btn-download-pdf') {
                    input.disabled = isLocked;
                }
            });

            if (isLocked) {
                saveStatus.textContent = "ƒê√£ n·ªôp, kh√¥ng th·ªÉ s·ª≠a.";
            } else {
                saveStatus.textContent = "";
            }
        }

        // --- 6. L∆ØU D·ªÆ LI·ªÜU ƒê·ªÄ C∆Ø∆†NG (POST) ---
        let saveTimeout;
        // G·ªôp h√†m l∆∞u v√† n·ªôp b√†i
        async function saveDeCuong(status = 'ban_nhap') {
            clearTimeout(saveTimeout);
            saveStatus.textContent = 'ƒêang l∆∞u...';
            
            const data = {
                ten_de_tai: elTenDeTai.value,
                ly_do_chon_de_tai: elLyDo.value,
                khung_ly_thuyet: elKhungLyThuyet.value,
                thiet_ke_va_to_chuc: elThietKe.value,
                thuc_nghiem: elThucNghiem.value,
                trang_thai: status // G·ª≠i c·∫£ tr·∫°ng th√°i
            };

            try {
                const response = await fetchAuthenticated(`${API_URL}/de-cuong/`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const responseData = await response.json();
                    saveStatus.textContent = (status === 'da_nop') ? 'ƒê√£ n·ªôp b√†i!' : 'ƒê√£ l∆∞u!';
                    updateStatusUI(responseData.trang_thai); // C·∫≠p nh·∫≠t UI v·ªõi tr·∫°ng th√°i m·ªõi
                } else {
                    saveStatus.textContent = 'L·ªói! Kh√¥ng th·ªÉ l∆∞u.';
                }
            } catch (err) {
                saveStatus.textContent = 'L·ªói k·∫øt n·ªëi.';
            }

            saveTimeout = setTimeout(() => {
                saveStatus.textContent = '';
            }, 3000);
        }
        
        // G√°n s·ª± ki·ªán cho c√°c n√∫t l∆∞u
        btnSaveDraft.addEventListener('click', () => saveDeCuong('ban_nhap'));
        
        btnSubmitFinal.addEventListener('click', () => {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën N·ªòP B√ÄI kh√¥ng? Sau khi n·ªôp, b·∫°n s·∫Ω kh√¥ng th·ªÉ ch·ªânh s·ª≠a.')) {
                saveDeCuong('da_nop');
            }
        });

        // --- 7. G·ªåI √ù AI ---
        // S·ª≠a l·ªói: G√°n s·ª± ki·ªán cho c·∫£ 4 n√∫t
        btnAiLyDo.addEventListener('click', () => {
            const prompt = elLyDo.value;
            if (prompt.length < 50) {
                alert('B·∫°n c·∫ßn vi·∫øt √≠t nh·∫•t 50 k√Ω t·ª± ƒë·ªÉ AI c√≥ th·ªÉ ƒë∆∞a ra g·ª£i √Ω t·ªët.');
                return;
            }
            getAISuggestion(prompt);
        });

        btnAiKhungLyThuyet.addEventListener('click', () => {
            const prompt = elKhungLyThuyet.value;
            if (prompt.length < 50) {
                alert('B·∫°n c·∫ßn vi·∫øt √≠t nh·∫•t 50 k√Ω t·ª± ƒë·ªÉ AI c√≥ th·ªÉ ƒë∆∞a ra g·ª£i √Ω t·ªët.');
                return;
            }
            getAISuggestion(prompt);
        });

        btnAiThietKe.addEventListener('click', () => {
            const prompt = elThietKe.value;
            if (prompt.length < 50) {
                alert('B·∫°n c·∫ßn vi·∫øt √≠t nh·∫•t 50 k√Ω t·ª± ƒë·ªÉ AI c√≥ th·ªÉ ƒë∆∞a ra g·ª£i √Ω t·ªët.');
                return;
            }
            getAISuggestion(prompt);
        });

        btnAiThucNghiem.addEventListener('click', () => {
            const prompt = elThucNghiem.value;
            if (prompt.length < 50) {
                alert('B·∫°n c·∫ßn vi·∫øt √≠t nh·∫•t 50 k√Ω t·ª± ƒë·ªÉ AI c√≥ th·ªÉ ƒë∆∞a ra g·ª£i √Ω t·ªët.');
                return;
            }
            getAISuggestion(prompt);
        });


        async function getAISuggestion(prompt) {
            showModal(true); // Hi·ªÉn th·ªã loading

            try {
                const response = await fetchAuthenticated(`${API_URL}/goi-y-ai/`, {
                    method: 'POST',
                    body: JSON.stringify({ prompt: prompt })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showModal(false, data.goi_y);
                } else {
                    showModal(false, null, true); // Hi·ªÉn th·ªã l·ªói
                }
            } catch (err) {
                showModal(false, null, true); // Hi·ªÉn th·ªã l·ªói
            }
        }

        // --- 8. X·ª¨ L√ù MODAL (POP-UP) ---
        function showModal(isLoading, result = null, isError = false) {
            aiModal.style.display = 'block';
            if (isLoading) {
                modalLoading.style.display = 'block';
                modalResult.style.display = 'none';
                modalError.style.display = 'none';
            } else if (isError) {
                modalLoading.style.display = 'none';
                modalResult.style.display = 'none';
                modalError.style.display = 'block';
            } else {
                modalLoading.style.display = 'none';
                modalError.style.display = 'none';
                modalResult.innerHTML = `<p>${result}</p>`; // Ch√®n n·ªôi dung AI
                modalResult.style.display = 'block';
            }
        }
        function closeModal() {
            aiModal.style.display = 'none';
        }
        closeModalBtn.onclick = closeModal;
        window.onclick = function(event) {
            if (event.target == aiModal) {
                closeModal();
            }
        }
        
        // --- 9. X·ª¨ L√ù DOWNLOAD PDF ---
        btnDownloadPDF.addEventListener('click', async () => {
            alert('ƒêang t·∫°o t·ªáp PDF, vi·ªác n√†y c√≥ th·ªÉ m·∫•t v√†i gi√¢y...');
            
            try {
                const response = await fetchAuthenticated(`${API_URL}/de-cuong/pdf/`, {
                    method: 'GET'
                });

                if (response.ok) {
                    // X·ª≠ l√Ω t·ªáp blob
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'DeCuongLuanVan.pdf'; // T√™n t·ªáp
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    alert('L·ªói: Kh√¥ng th·ªÉ t·∫°o t·ªáp PDF.');
                }
            } catch (err) {
                alert('L·ªói k·∫øt n·ªëi khi t·∫£i PDF.');
            }
        });

        // --- 10. T·ª∞ ƒê·ªòNG KI·ªÇM TRA ƒêƒÇNG NH·∫¨P KHI T·∫¢I TRANG ---
        (async function checkLoginOnLoad() {
            const accessToken = localStorage.getItem('access_token');
            const username = localStorage.getItem('username');
            if (accessToken && username) {
                // Th·ª≠ t·∫£i ƒë·ªÅ c∆∞∆°ng ƒë·ªÉ ki·ªÉm tra token c√≥ h·ª£p l·ªá kh√¥ng
                const response = await fetchAuthenticated(`${API_URL}/de-cuong/`);
                if (response.ok) {
                    showAppView(username);
                } else {
                    // Token c√≥ th·ªÉ ƒë√£ h·∫øt h·∫°n v√† refresh th·∫•t b·∫°i
                    doLogout();
                }
            } else {
                showLoginView();
            }
        })();


        // --- C√ÅC H√ÄM CHUY·ªÇN ƒê·ªîI GIAO DI·ªÜN ---
        function showAppView(username) {
            document.getElementById('welcome-message').textContent = `Ch√†o, ${username}!`;
            loginView.style.display = 'none';
            registerView.style.display = 'none';
            appView.style.display = 'block';
            loadDeCuong(); // T·∫£i ƒë·ªÅ c∆∞∆°ng khi hi·ªÉn th·ªã app
        }
        function showLoginView() {
            loginView.style.display = 'block';
            registerView.style.display = 'none';
            appView.style.display = 'none';
            loginForm.reset();
            loginError.style.display = 'none';
        }
        function showRegisterView() {
            loginView.style.display = 'none';
            registerView.style.display = 'block';
            appView.style.display = 'none';
            registerForm.reset();
            registerError.style.display = 'none';
        }

        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showLoginView(); });
        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showRegisterView(); });

    </script>
</body>
</html>